<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buku Kas Rumah Tangga Maulana & Ninda</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .loading { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen">
    <div class="container mx-auto px-4 py-6 max-w-7xl">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-slate-700 mb-2">üí∞Buku Kas Rumah Tangga Maulana & Ninda</h1>
            <p class="text-slate-500">Rajin mencatat pengeluaran rumah tangga adalah bagian dari menjaga amanah harta yang Allah titipkan, karena dalam Al-Qur'an Allah memerintahkan agar tidak berlebih-lebihan dalam membelanjakan harta (QS. Al-A'raf: 31) dan Rasulullah Ô∑∫ bersabda bahwa setiap harta akan dimintai pertanggungjawaban dari mana yang diperoleh dan untuk apa yang dibelanjakan (HR. Tirmidzi), maka semoga Allah memberkahi rezeki kita dengan doa: 'Allahumma barik lana fima razaqtana, Allahumma akfini bihalalika 'an haramika wa aghnini bifadhlika 'amman siwak'.‚Äù ü§≤</p>
            <div id="connectionStatus" class="mt-2">
                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                    üîÑ Menghubungkan ke database...
                </span>
            </div>
        </div>

        <div class="bg-gradient-to-r from-blue-500 to-blue-700 rounded-3xl p-6 mb-8 shadow-lg">
            <div class="text-center">
                <h2 class="text-white text-lg font-medium mb-2">Total Pengeluaran</h2>
                <div id="totalAmount" class="text-white text-4xl font-bold">Rp 0</div>
                <p class="text-blue-100 text-sm mt-2">Bulan ini</p>
            </div>
        </div>

        <div class="grid lg:grid-cols-3 gap-6 mb-8">
            <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-200">
                <h3 class="text-xl font-semibold text-slate-700 mb-4 text-center">Tambah Pengeluaran</h3>
                <form id="expenseForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-2">Tanggal</label>
                        <input type="date" id="date" name="date" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-2">Kategori</label>
                        <select id="category" name="category" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all" required>
                            <option value="">Pilih Kategori</option>
                            <option value="Kebutuhan Rumah">üè† Kebutuhan Rumah</option>
                            <option value="Makan & Minum">üçö Makan & Minum</option>
                            <option value="Transportasi">üöó Transportasi</option>
                            <option value="Pendidikan">üéì Pendidikan</option>
                            <option value="Kesehatan">üè• Kesehatan</option>
                            <option value="Kebutuhan Pribadi">üõç Kebutuhan Pribadi</option>
                            <option value="Hiburan & Gaya Hidup">üéâ Hiburan & Gaya Hidup</option>
                            <option value="Cicilan & Tagihan">üí≥ Cicilan & Tagihan</option>
                            <option value="Tabungan & Investasi">üí∞ Tabungan & Investasi</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-2">Keterangan</label>
                        <input type="text" id="description" name="description" placeholder="Contoh: Bayar Listrik / Beli Beras" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-2">Jumlah (Rp)</label>
                        <input type="text" id="amount" name="amount" placeholder="0" class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all" required>
                    </div>
                    <button type="submit" id="submitBtn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-medium py-3 px-6 rounded-xl transition-all shadow-sm disabled:opacity-50">
                        Tambah Pengeluaran
                    </button>
                </form>
            </div>

            <div class="lg:col-span-2 bg-white rounded-2xl p-6 shadow-sm border border-slate-200">
                <h3 class="text-xl font-semibold text-slate-700 mb-4">Riwayat Pengeluaran</h3>
                <div id="expenseList" class="space-y-3 max-h-[500px] overflow-y-auto pr-2">
                    <div class="loading text-center py-8 text-slate-400">Memuat data...</div>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-200">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
                <h3 class="text-xl font-semibold text-slate-700">Visualisasi Data</h3>
                <div class="flex gap-2 mt-4 sm:mt-0">
                    <button onclick="showChart('weekly')" id="weeklyBtn" class="px-4 py-2 bg-blue-500 text-white rounded-lg text-sm font-medium">Mingguan</button>
                    <button onclick="showChart('monthly')" id="monthlyBtn" class="px-4 py-2 bg-slate-200 text-slate-600 rounded-lg text-sm font-medium">Bulanan</button>
                </div>
            </div>
            <div class="relative h-80">
                <canvas id="expenseChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        // MASUKKAN URL APPS SCRIPT ANDA DI SINI
        const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw-AD4x1u5Xe1BylYyVJXR-QimbC-GgrDA6ph-DD-yOWfENnw7z3mv345AG_KtwKaIt/exec';
        
        let expenses = [];
        let currentChart = null;
        let currentChartType = 'weekly';

        // Format Rupiah
        function formatCurrency(amount) {
            return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount);
        }

        // Format input ribuan
        document.getElementById('amount').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            e.target.value = value.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        });

        function updateConnectionStatus(status, message) {
            const el = document.getElementById('connectionStatus');
            const colors = { loading: 'bg-yellow-100 text-yellow-800', success: 'bg-green-100 text-green-800', error: 'bg-red-100 text-red-800' };
            const icons = { loading: 'üîÑ', success: '‚úÖ', error: '‚ùå' };
            el.innerHTML = `<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${colors[status]}">${icons[status]} ${message}</span>`;
        }

        async function fetchExpenses() {
            try {
                updateConnectionStatus('loading', 'Memuat data...');
                const response = await fetch(GOOGLE_APPS_SCRIPT_URL);
                const result = await response.json();
                if (result.success) {
                    expenses = result.data;
                    updateConnectionStatus('success', 'Terhubung ke Google Sheets');
                    renderExpenses();
                    updateTotal();
                    updateChart();
                }
            } catch (error) {
                updateConnectionStatus('error', 'Gagal memuat data');
            }
        }

        async function deleteExpense(rowId) {
            if (!confirm("Hapus data ini?")) return;
            try {
                updateConnectionStatus('loading', 'Menghapus...');
                const response = await fetch(`${GOOGLE_APPS_SCRIPT_URL}?id=${rowId}`);
                const result = await response.json();
                if (result.success) {
                    updateConnectionStatus('success', 'Data dihapus');
                    fetchExpenses();
                }
            } catch (error) {
                updateConnectionStatus('error', 'Gagal menghapus');
            }
        }

        document.getElementById('expenseForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            btn.textContent = 'Menyimpan...';

            const data = {
                date: document.getElementById('date').value,
                category: document.getElementById('category').value,
                description: document.getElementById('description').value,
                amount: document.getElementById('amount').value.replace(/\./g, '')
            };

            try {
                const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                if (result.success) {
                    this.reset();
                    document.getElementById('date').value = new Date().toISOString().split('T')[0];
                    fetchExpenses();
                }
            } catch (error) {
                updateConnectionStatus('error', 'Gagal menyimpan');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Tambah Pengeluaran';
            }
        });

        function renderExpenses() {
            const list = document.getElementById('expenseList');
            if (expenses.length === 0) {
                list.innerHTML = `<div class="text-center py-8 text-slate-400">Belum ada data</div>`;
                return;
            }
            list.innerHTML = expenses.map(exp => `
                <div class="flex justify-between items-center p-4 bg-slate-50 rounded-xl border border-slate-100">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="px-2 py-0.5 rounded text-[10px] font-bold bg-blue-100 text-blue-700 uppercase">${exp.category}</span>
                            <span class="text-xs text-slate-400">${exp.date}</span>
                        </div>
                        <h4 class="font-medium text-slate-700">${exp.description}</h4>
                    </div>
                    <div class="text-right ml-4 flex flex-col items-end">
                        <p class="font-bold text-slate-700">${formatCurrency(exp.amount)}</p>
                        <button onclick="deleteExpense(${exp.id})" class="text-[10px] text-red-400 hover:text-red-600 mt-1 uppercase font-bold tracking-tighter">Hapus</button>
                    </div>
                </div>
            `).join('');
        }

        function updateTotal() {
            const now = new Date();
            const total = expenses
                .filter(exp => new Date(exp.date).getMonth() === now.getMonth())
                .reduce((sum, exp) => sum + parseInt(exp.amount), 0);
            document.getElementById('totalAmount').textContent = formatCurrency(total);
        }

        function updateChart() {
            if (currentChart) currentChart.destroy();
            const ctx = document.getElementById('expenseChart').getContext('2d');
            
            const labels = [...new Set(expenses.map(exp => exp.category))];
            const data = labels.map(label => 
                expenses.filter(exp => exp.category === label).reduce((sum, exp) => sum + parseInt(exp.amount), 0)
            );

            currentChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#f97316', '#64748b']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        window.onload = () => {
            document.getElementById('date').value = new Date().toISOString().split('T')[0];
            fetchExpenses();
        };
    </script>
</body>
</html>

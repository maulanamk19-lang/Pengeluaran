<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buku Kas Rumah Tangga - Google Sheets Integration</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .loading {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen">
    <div class="container mx-auto px-4 py-6 max-w-7xl">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-slate-700 mb-2">üí∞ Buku Kas Rumah Tangga</h1>
            <p class="text-slate-500">Kelola pengeluaran dengan Google Spreadsheet</p>
            <div id="connectionStatus" class="mt-2">
                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                    üîÑ Menghubungkan ke database...
                </span>
            </div>
        </div>

        <!-- Kartu Total Pengeluaran -->
        <div class="bg-gradient-to-r from-blue-500 to-blue-700 rounded-3xl p-6 mb-8 shadow-lg">
            <div class="text-center">
                <h2 class="text-white text-lg font-medium mb-2">Total Pengeluaran</h2>
                <div id="totalAmount" class="text-white text-4xl font-bold">Rp 0</div>
                <p class="text-blue-100 text-sm mt-2">Bulan ini</p>
            </div>
        </div>

        <div class="grid lg:grid-cols-3 gap-6 mb-8">
            <!-- Form Input -->
            <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-200">
                <h3 class="text-xl font-semibold text-slate-700 mb-4">Tambah Pengeluaran</h3>
                <form id="expenseForm" class="space-y-4">
                    <div>
                        <label for="date" class="block text-sm font-medium text-slate-600 mb-2">Tanggal</label>
                        <input 
                            type="date" 
                            id="date" 
                            name="date"
                            class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all"
                            required
                        >
                    </div>
                    <div>
                        <label for="category" class="block text-sm font-medium text-slate-600 mb-2">Kategori</label>
                        <select 
                            id="category" 
                            name="category"
                            class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all"
                            required
                        >
                            <option value="">Pilih Kategori</option>
                            <option value="Makanan">Makanan</option>
                            <option value="Olahraga">Olahraga</option>
                            <option value="Investasi">Investasi</option>
                            <option value="Lainnya">Lainnya</option>
                        </select>
                    </div>
                    <div>
                        <label for="description" class="block text-sm font-medium text-slate-600 mb-2">Keterangan</label>
                        <input 
                            type="text" 
                            id="description" 
                            name="description"
                            placeholder="Contoh: Makan siang di warung"
                            class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all"
                            required
                        >
                    </div>
                    <div>
                        <label for="amount" class="block text-sm font-medium text-slate-600 mb-2">Jumlah (Rp)</label>
                        <input 
                            type="text" 
                            id="amount" 
                            name="amount"
                            placeholder="25.000"
                            class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all"
                            required
                        >
                    </div>
                    <button 
                        type="submit"
                        id="submitBtn"
                        class="w-full bg-blue-500 hover:bg-blue-600 text-white font-medium py-3 px-6 rounded-xl transition-colors duration-200 shadow-sm disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        Tambah Pengeluaran
                    </button>
                </form>
            </div>

            <!-- Daftar Riwayat -->
            <div class="lg:col-span-2 bg-white rounded-2xl p-6 shadow-sm border border-slate-200">
                <h3 class="text-xl font-semibold text-slate-700 mb-4">Riwayat Pengeluaran</h3>
                <div id="expenseList" class="space-y-3 max-h-96 overflow-y-auto">
                    <!-- Loading state -->
                    <div class="loading text-center py-8 text-slate-400">
                        <p>Memuat data...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Area Grafik -->
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-200">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
                <h3 class="text-xl font-semibold text-slate-700 mb-4 sm:mb-0">Visualisasi Data</h3>
                <div class="flex flex-wrap gap-2">
                    <button onclick="showChart('weekly')" id="weeklyBtn" class="px-4 py-2 bg-blue-500 text-white rounded-lg text-sm font-medium transition-colors">Mingguan</button>
                    <button onclick="showChart('monthly')" id="monthlyBtn" class="px-4 py-2 bg-slate-200 text-slate-600 rounded-lg text-sm font-medium transition-colors">Bulanan</button>
                    <button onclick="showChart('yearly')" id="yearlyBtn" class="px-4 py-2 bg-slate-200 text-slate-600 rounded-lg text-sm font-medium transition-colors">Tahunan</button>
                </div>
            </div>
            <div class="relative h-64 sm:h-80">
                <canvas id="expenseChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        // Konfigurasi - GANTI URL INI DENGAN URL WEB APP ANDA
        const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw-AD4x1u5Xe1BylYyVJXR-QimbC-GgrDA6ph-DD-yOWfENnw7z3mv345AG_KtwKaIt/exec';
        
        // State management
        let expenses = [];
        let currentChart = null;
        let currentChartType = 'weekly';

        // Data dummy untuk placeholder
        const dummyData = [
            { id: 1, date: '2026-02-20', category: 'Makanan', description: 'Beli Tongseng Ayam', amount: 85000, timestamp: new Date('2026-02-20') },
            { id: 2, date: '2026-02-21', category: 'Olahraga', description: 'Sewa Lapangan Badminton', amount: 75000, timestamp: new Date('2026-02-21') },
            { id: 3, date: '2026-02-22', category: 'Investasi', description: 'Investasi ORI029T3', amount: 1000000, timestamp: new Date('2026-02-22') },
            { id: 4, date: '2026-02-23', category: 'Makanan', description: 'Beli Bakso', amount: 25000, timestamp: new Date('2026-02-23') }
        ];

        // Format mata uang Rupiah
        function formatCurrency(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(amount);
        }

        // Format input angka dengan titik pemisah ribuan
        function formatNumberInput(input) {
            let value = input.value.replace(/\D/g, '');
            value = value.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            input.value = value;
        }

        // Parse angka dari input yang sudah diformat
        function parseFormattedNumber(value) {
            return parseInt(value.replace(/\./g, '')) || 0;
        }

        // Format tanggal
        function formatDate(date) {
            const d = new Date(date);
            return new Intl.DateTimeFormat('id-ID', {
                day: 'numeric',
                month: 'short',
                year: 'numeric'
            }).format(d);
        }

        // Update status koneksi
        function updateConnectionStatus(status, message) {
            const statusEl = document.getElementById('connectionStatus');
            const statusClasses = {
                loading: 'bg-yellow-100 text-yellow-800',
                success: 'bg-green-100 text-green-800',
                error: 'bg-red-100 text-red-800'
            };
            
            const icons = {
                loading: 'üîÑ',
                success: '‚úÖ',
                error: '‚ùå'
            };
            
            statusEl.innerHTML = `
                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${statusClasses[status]}">
                    ${icons[status]} ${message}
                </span>
            `;
        }

        // Fetch data dari Google Sheets
        async function fetchExpenses() {
            try {
                updateConnectionStatus('loading', 'Memuat data dari Google Sheets...');
                
                const response = await fetch(GOOGLE_APPS_SCRIPT_URL);
                const result = await response.json();
                
                if (result.success) {
                    expenses = result.data.length > 0 ? result.data : dummyData;
                    updateConnectionStatus('success', 'Terhubung ke Google Sheets');
                } else {
                    throw new Error(result.error || 'Gagal memuat data');
                }
            } catch (error) {
                console.error('Error fetching data:', error);
                expenses = dummyData;
                updateConnectionStatus('error', 'Menggunakan data offline');
            }
            
            renderExpenses();
            updateTotal();
            updateChart();
        }

        // Kirim data ke Google Sheets
        async function addExpenseToSheet(expenseData) {
            try {
                const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(expenseData)
                });
                
                const result = await response.json();
                return result;
            } catch (error) {
                console.error('Error adding expense:', error);
                return { success: false, error: error.message };
            }
        }

        // Hitung total pengeluaran
        function calculateTotal() {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            
            return expenses
                .filter(expense => {
                    const expenseDate = new Date(expense.date);
                    return expenseDate.getMonth() === currentMonth && expenseDate.getFullYear() === currentYear;
                })
                .reduce((total, expense) => total + parseInt(expense.amount), 0);
        }

        // Update tampilan total
        function updateTotal() {
            const total = calculateTotal();
            document.getElementById('totalAmount').textContent = formatCurrency(total);
        }

        // Render daftar pengeluaran
        function renderExpenses() {
            const expenseList = document.getElementById('expenseList');
            
            if (expenses.length === 0) {
                expenseList.innerHTML = `
                    <div class="text-center py-12 text-slate-400">
                        <div class="text-6xl mb-4">üìù</div>
                        <h4 class="text-lg font-medium text-slate-600 mb-2">Belum ada pengeluaran</h4>
                        <p class="text-sm">Mulai catat pengeluaran pertama Anda!</p>
                    </div>
                `;
                return;
            }

            // Sort by date descending (terbaru di atas)
            const sortedExpenses = [...expenses].sort((a, b) => new Date(b.date) - new Date(a.date));

            expenseList.innerHTML = sortedExpenses.map(expense => `
                <div class="flex justify-between items-center p-4 bg-slate-50 rounded-xl border border-slate-100 hover:shadow-sm transition-shadow">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="inline-flex items-center px-2 py-1 rounded-md text-xs font-medium bg-blue-100 text-blue-800">
                                ${expense.category}
                            </span>
                            <span class="text-sm text-slate-500">${formatDate(expense.date)}</span>
                        </div>
                        <h4 class="font-medium text-slate-700">${expense.description}</h4>
                    </div>
                    <div class="text-right ml-4">
                        <p class="font-semibold text-slate-700">${formatCurrency(expense.amount)}</p>
                    </div>
                </div>
            `).join('');
        }

        // Update grafik
        function updateChart() {
            if (currentChart) {
                currentChart.destroy();
            }
            
            const ctx = document.getElementById('expenseChart').getContext('2d');
            const chartData = getChartData(currentChartType);
            
            currentChart = new Chart(ctx, {
                type: currentChartType === 'monthly' || currentChartType === 'yearly' ? 'line' : 'bar',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        // Dapatkan data untuk grafik
        function getChartData(type) {
            const now = new Date();
            let labels = [];
            let data = [];
            
            if (type === 'weekly') {
                // 7 hari terakhir
                for (let i = 6; i >= 0; i--) {
                    const date = new Date(now);
                    date.setDate(date.getDate() - i);
                    labels.push(date.toLocaleDateString('id-ID', { weekday: 'short', day: 'numeric' }));
                    
                    const dayExpenses = expenses.filter(expense => {
                        const expenseDate = new Date(expense.date);
                        return expenseDate.toDateString() === date.toDateString();
                    });
                    
                    const total = dayExpenses.reduce((sum, expense) => sum + parseInt(expense.amount), 0);
                    data.push(total);
                }
            } else if (type === 'monthly') {
                // 12 bulan terakhir
                for (let i = 11; i >= 0; i--) {
                    const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                    labels.push(date.toLocaleDateString('id-ID', { month: 'short', year: '2-digit' }));
                    
                    const monthExpenses = expenses.filter(expense => {
                        const expenseDate = new Date(expense.date);
                        return expenseDate.getMonth() === date.getMonth() && 
                               expenseDate.getFullYear() === date.getFullYear();
                    });
                    
                    const total = monthExpenses.reduce((sum, expense) => sum + parseInt(expense.amount), 0);
                    data.push(total);
                }
            } else if (type === 'yearly') {
                // 5 tahun terakhir
                for (let i = 4; i >= 0; i--) {
                    const year = now.getFullYear() - i;
                    labels.push(year.toString());
                    
                    const yearExpenses = expenses.filter(expense => {
                        const expenseDate = new Date(expense.date);
                        return expenseDate.getFullYear() === year;
                    });
                    
                    const total = yearExpenses.reduce((sum, expense) => sum + parseInt(expense.amount), 0);
                    data.push(total);
                }
            }
            
            return {
                labels: labels,
                datasets: [{
                    label: 'Pengeluaran',
                    data: data,
                    backgroundColor: 'rgba(59, 130, 246, 0.5)',
                    borderColor: 'rgb(59, 130, 246)',
                    borderWidth: 2,
                    fill: type !== 'bar'
                }]
            };
        }

        // Ganti jenis grafik
        function showChart(type) {
            currentChartType = type;
            
            // Update button states
            document.querySelectorAll('[id$="Btn"]').forEach(btn => {
                btn.className = btn.className.replace('bg-blue-500 text-white', 'bg-slate-200 text-slate-600');
            });
            
            document.getElementById(type + 'Btn').className = 
                document.getElementById(type + 'Btn').className.replace('bg-slate-200 text-slate-600', 'bg-blue-500 text-white');
            
            updateChart();
        }

        // Handle form submit
        document.getElementById('expenseForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.textContent;
            
            // Disable button dan ubah text
            submitBtn.disabled = true;
            submitBtn.textContent = 'Menyimpan...';
            
            const formData = new FormData(this);
            const expenseData = {
                date: formData.get('date'),
                category: formData.get('category'),
                description: formData.get('description'),
                amount: parseFormattedNumber(formData.get('amount'))
            };
            
            // Tambah ke Google Sheets
            const result = await addExpenseToSheet(expenseData);
            
            if (result.success) {
                // Tambah ke array lokal
                const newExpense = {
                    ...expenseData,
                    id: result.id || Date.now(),
                    timestamp: new Date()
                };
                expenses.unshift(newExpense);
                
                // Update tampilan
                renderExpenses();
                updateTotal();
                updateChart();
                
                // Reset form
                this.reset();
                document.getElementById('date').value = new Date().toISOString().split('T')[0];
                document.getElementById('description').focus();
                
                updateConnectionStatus('success', 'Data berhasil disimpan');
            } else {
                updateConnectionStatus('error', 'Gagal menyimpan: ' + (result.error || 'Unknown error'));
            }
            
            // Re-enable button
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
        });

        // Format input amount saat mengetik
        document.getElementById('amount').addEventListener('input', function(e) {
            formatNumberInput(e.target);
        });

        // Inisialisasi
        document.addEventListener('DOMContentLoaded', function() {
            // Set tanggal hari ini sebagai default
            document.getElementById('date').value = new Date().toISOString().split('T')[0];
            
            // Load data
            fetchExpenses();
        });
    </script>
</body>
</html>